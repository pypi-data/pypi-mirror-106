function k(n,o){var r=Object.keys(n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(n);o&&(s=s.filter(function(d){return Object.getOwnPropertyDescriptor(n,d).enumerable})),r.push.apply(r,s)}return r}function S(n){for(var o=1;o<arguments.length;o++){var r=arguments[o]!=null?arguments[o]:{};o%2?k(Object(r),!0).forEach(function(s){Z(n,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach(function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))})}return n}function Z(n,o,r){return o in n?Object.defineProperty(n,o,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[o]=r,n}import a,{useCallback as c,useEffect as _,useImperativeHandle as ee,useLayoutEffect as te,useMemo as q,useRef as P,useState as T}from"../../../web_modules/react.js";import ne from"./ChartOperations.js";import re from"../ScatterChart/index.js";import{rem as ie}from"../../utils/style.js";import D from"../../../web_modules/styled-components.js";import{useTranslation as oe}from"../../../web_modules/react-i18next.js";import se from"../../hooks/useWorker.js";const ae=D.div.withConfig({displayName:"HighDimensionalChart__Wrapper",componentId:"sc-179pidq-0"})(["height:100%;display:flex;flex-direction:column;justify-content:stretch;align-items:stretch;"]),le=D.div.withConfig({displayName:"HighDimensionalChart__Toolbar",componentId:"sc-179pidq-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> .info{color:var(--text-light-color);> .sep{display:inline-block;width:1px;background-color:var(--border-color);margin:0 1em;height:1em;vertical-align:middle;}}"],ie(20)),ce=D.div.withConfig({displayName:"HighDimensionalChart__Chart",componentId:"sc-179pidq-2"})(["width:100%;height:100%;overflow:hidden;font-size:0;*{outline:none;}"]),A=a.forwardRef(({vectors:n,labels:o,colorMap:r,shape:s,dim:d,is3D:I,reduction:t,perplexity:p,learningRate:f,neighbors:F,focusedIndices:W,highlightIndices:U,onCalculate:h,onCalculated:v,onError:g,className:M},z)=>{var E;const{t:b}=oe(["high-dimensional","common"]),H=P(null),L=P(null),[$,B]=T(0),[K,G]=T(0),[C,J]=T(!1),Q=q(()=>C?"labels":"points",[C]);te(()=>{const i=H.current;if(i){let j=null;const x=new ResizeObserver(()=>{j!=null&&(cancelAnimationFrame(j),j=null),j=requestAnimationFrame(()=>{const R=i.getBoundingClientRect();B(R.width),G(R.height)})});return x.observe(i),()=>x.unobserve(i)}},[]);const V=q(()=>{const i={input:n,dim:d,n:I?3:2};switch(t){case"pca":return{reduction:t,params:S({},i)};case"tsne":return{reduction:t,params:S({perplexity:p,epsilon:f},i)};case"umap":return{reduction:t,params:S({neighbors:F},i)};default:return null}},[d,I,f,F,p,t,n]),{data:l,error:N,worker:e}=se("high-dimensional/calculate",V),w=P(null),O=c(()=>{e==null||e.emit("INFO",{type:"step"})},[e]),y=c(()=>{w.current=requestAnimationFrame(O)},[O]),m=c(()=>{t==="tsne"&&(e==null||e.on("RESULT",y),O())},[t,e,y,O]),u=c(()=>{t==="tsne"&&(w.current&&(cancelAnimationFrame(w.current),w.current=null),e==null||e.off("RESULT",y))},[t,e,y]),X=c(()=>{t==="tsne"&&(u(),e==null||e.emit("INFO",{type:"reset"}),e==null||e.once("RESULT",()=>m()))},[t,m,u,e]);_(()=>{if(t==="tsne")return m(),()=>{u()}},[t,m,u]),_(()=>{t==="tsne"&&(e==null||e.emit("INFO",{type:"params",data:{perplexity:p,epsilon:f}}))},[t,p,f,e]);const Y=c(()=>{t==="umap"&&(e==null||e.emit("INFO"))},[t,e]);return _(()=>{N?g==null||g(N):l?v==null||v(l):h==null||h()},[l,N,h,v,g]),ee(z,()=>({pauseTSNE:u,resumeTSNE:m,rerunTSNE:X,rerunUMAP:Y})),a.createElement(ae,{className:M},a.createElement(le,null,a.createElement("div",{className:"info"},b("high-dimensional:points"),b("common:colon"),s[0],a.createElement("span",{className:"sep"}),b("high-dimensional:data-dimension"),b("common:colon"),s[1]),a.createElement(ne,{labelCloud:C,onToggleLabelCloud:()=>J(i=>!i),onReset:()=>{var i;return(i=L.current)===null||i===void 0?void 0:i.reset()}})),a.createElement(ce,{ref:H},a.createElement(re,{ref:L,width:$,height:K,data:(E=l==null?void 0:l.vectors)!==null&&E!==void 0?E:[],labels:o,colorMap:r,is3D:I,rotate:t!=="tsne",focusedIndices:W,highlightIndices:U,type:Q})))});A.displayName="HighDimensionalChart";export default A;
