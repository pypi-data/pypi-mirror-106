function ne(r,u){if(r==null)return{};var n=le(r,u),l,o;if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(r);for(o=0;o<d.length;o++)l=d[o],!(u.indexOf(l)>=0)&&(!Object.prototype.propertyIsEnumerable.call(r,l)||(n[l]=r[l]))}return n}function le(r,u){if(r==null)return{};var n={},l=Object.keys(r),o,d;for(d=0;d<l.length;d++)o=l[d],!(u.indexOf(o)>=0)&&(n[o]=r[o]);return n}function E(){return E=Object.assign||function(r){for(var u=1;u<arguments.length;u++){var n=arguments[u];for(var l in n)Object.prototype.hasOwnProperty.call(n,l)&&(r[l]=n[l])}return r},E.apply(this,arguments)}import{ExpandContainer as ae,TBody as oe,THead as ie,Table as me,Td as de,Tr as S}from"../../Table.js";import m,{useCallback as f,useEffect as v,useLayoutEffect as ce,useMemo as g,useRef as ue,useState as w}from"../../../../web_modules/react.js";import{color as z,colorAlt as M}from"../../../utils/chart.js";import{useColumnOrder as pe,useExpanded as fe,useFlexLayout as ge,useResizeColumns as be,useSortBy as he,useTable as ye}from"../../../../web_modules/react-table.js";import G from"./Cell.js";import{DndProvider as Ce}from"../../../../web_modules/react-dnd.js";import je from"./DraggableTh.js";import{HTML5Backend as Ee}from"../../../../web_modules/react-dnd-html5-backend.js";import L from"./Header.js";import ve from"../MetricGraphs.js";import we from"./MetricsHeader.js";import ke from"./NameCell.js";import Pe from"./NameHeader.js";import Te from"../../../../web_modules/classnames.js";import Re from"../../../hooks/useClassNames.js";import{useSticky as De}from"../../../../web_modules/react-table-sticky.js";const He=({indicators:r,list:u,sortBy:n,columnOrder:l,onOrderChange:o,expand:d,expandAll:$})=>{const k=ue(null),F=g(()=>({minWidth:100,draggable:!0}),[]),A=g(()=>[{accessor:"name",Header:d?Pe:L,Cell:d?ke:G,width:200,sticky:"left",draggable:!1},...r.map(({name:e,group:t})=>({accessor:`${t}.${e}`,id:e,Header:t==="metrics"?we:L,Cell:G,minWidth:200}))],[d,r]),V=g(()=>l?["name",...l]:[],[l]),{getTableProps:q,headerGroups:B,rows:J,prepareRow:K,setSortBy:P,setColumnOrder:T,state:R,totalColumnsWidth:j,visibleColumns:D,allColumns:H}=ye({columns:A,data:u,defaultColumn:F,initialState:{sortBy:n!=null?n:[],columnOrder:V},autoResetExpanded:!1},ge,De,be,he,pe,fe);v(()=>{H.forEach(e=>{const t=r.find(s=>s.name===e.id);t&&e.toggleHidden(!t.selected)})},[H,r]),v(()=>P(n!=null?n:[]),[P,n]);const[i,N]=w(null),[c,Q]=w(null),U=f(e=>N(e),[]),X=f(()=>N(null),[]),Y=f((e,t)=>Q([e,t]),[]),a=g(()=>D.map(e=>e.id),[D]);v(()=>{o==null||o(a.filter(e=>e!=="name"))},[o,a]);const x=g(()=>{if(i!=null&&c!=null){const[e,t]=c,s=a.findIndex(h=>h===e);if(t==="before"&&s>0)return a[s-1];if(t==="after"&&s<a.length-1)return a[s]}return null},[i,c,a]),O=g(()=>i!=null&&c&&c[1]==="before"&&a[0]===c[0],[i,c,a]),W=g(()=>i!=null&&c&&c[1]==="after"&&a[a.length-1]===c[0],[i,c,a]),Z=f((e,t)=>{if(i==null)return;const s=a.filter(C=>C!==i),h=a.findIndex(C=>C===i),p=s.findIndex(C=>C===e);let y=null;p===-1?y=h:t==="before"?y=p:t==="after"&&(y=p+1),y!=null&&(s.splice(y,0,i),T(s))},[i,a,T]),[b,ee]=w(0);ce(()=>{const e=k.current;if(e){const t=new ResizeObserver(()=>{const s=e.getBoundingClientRect();ee(s.width)});return t.observe(e),()=>t.unobserve(e)}},[]);const te=Re("sticky",{"is-droppable-left":O,"is-droppable-right":W},[O,W]),_=f(e=>({className:Te({"is-sticky":!!e.sticky,"is-resizing":R.columnResizing.isResizingColumn===e.id,"is-dragging":i===e.id,"is-droppable":x===e.id}),style:{position:e.sticky?"sticky":"relative"}}),[i,x,R.columnResizing.isResizingColumn]),I=f(()=>j>b?{style:{width:"fit-content"}}:{style:{width:"auto"}},[b,j]),re=f(()=>j>b?{style:{width:b-2}}:{style:{width:"auto"}},[b,j]),se=f(({index:e,values:t})=>({metrics:r.filter(s=>s.group==="metrics"&&s.selected).map(s=>s.name),run:{label:t.name,colors:[z[e%z.length],M[e%M.length]]}}),[r]);return m.createElement(Ce,{backend:Ee},m.createElement(me,E({},q({className:te,style:{minWidth:"unset"}}),{ref:k}),m.createElement(ie,I(),B.map(e=>m.createElement(S,e.getHeaderGroupProps(),e.headers.map(t=>m.createElement(je,E({},t.getHeaderProps([{className:t.className,style:t.style},_(t)]),{id:t.id,draggable:t.draggable,onDragStart:U,onDragEnd:X,onChangeDropSide:Y,onDrop:Z}),t.render("Header")))))),m.createElement(oe,I(),J.map(e=>{K(e);const t=e.getRowProps(),{key:s}=t,h=ne(t,["key"]);return m.createElement(m.Fragment,{key:s},m.createElement(S,h,e.cells.map(p=>m.createElement(de,p.getCellProps([{className:p.column.className,style:p.column.style},_(p.column)]),p.render("Cell")))),e.isExpanded||$?m.createElement(ae,re(),m.createElement(ve,se(e))):null)}))))};export default He;
