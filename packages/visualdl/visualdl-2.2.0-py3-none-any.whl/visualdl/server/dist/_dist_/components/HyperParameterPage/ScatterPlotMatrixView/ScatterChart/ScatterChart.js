function c(A,t,e){return t in A?Object.defineProperty(A,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):A[t]=e,A}import*as r from"../../../../../web_modules/d3.js";import k from"../../../../../web_modules/eventemitter3.js";import{ScaleMethod as b}from"../../../../resource/hyper-parameter/index.js";import O from"../../../../../web_modules/lodash/intersection.js";const D=2,w=4,R=5,M="#000",y=2;export default class L extends k{get margin(){const{MARGIN_WITHOUT_LABEL:t,MARGIN_LEFT_WITH_LABEL:e,MARGIN_BOTTOM_WITH_LABEL:l}=L;return{top:t,right:t,left:this.labelVisible[1]?e:t,bottom:this.labelVisible[0]?l:t}}get ticks(){return[this.scaleMethod[0]===b.LOGARITHMIC?y:this.width/30,this.scaleMethod[1]===b.LOGARITHMIC?y:this.height/20].map(Math.floor)}constructor(t,e){var l,a,n,g;super();c(this,"container",void 0),c(this,"width",void 0),c(this,"height",void 0),c(this,"labelVisible",[!0,!0]),c(this,"scale",[r.scaleLinear(),r.scaleLinear()]),c(this,"axis",[r.axisTop(r.scaleLinear()),r.axisRight(r.scaleLinear())]),c(this,"grid",[r.axisTop(r.scaleLinear()),r.axisRight(r.scaleLinear())]),c(this,"label",[r.axisBottom(r.scaleLinear()),r.axisLeft(r.scaleLinear())]),c(this,"svg",void 0),c(this,"brush",r.brush()),c(this,"dots",[]),c(this,"hoverDots",[]),c(this,"data",[]),c(this,"type",["continuous","continuous"]),c(this,"colors",[]),c(this,"scaleMethod",[null,null]),c(this,"hoveredIndex",null),c(this,"selectedIndex",null),c(this,"brushedIndexes",null),c(this,"brushing",!1),this.container=t,this.width=(l=e==null?void 0:e.width)!==null&&l!==void 0?l:150,this.height=(a=e==null?void 0:e.height)!==null&&a!==void 0?a:150,this.colors=(n=e==null?void 0:e.colors)!==null&&n!==void 0?n:[],this.labelVisible=(g=e==null?void 0:e.labelVisible)!==null&&g!==void 0?g:[!0,!0];const{left:x,right:f,top:p,bottom:u}=this.margin,i=this.width+x+f,s=this.height+p+u;this.svg=r.select(t).append("svg").attr("width",i).attr("height",s).attr("viewBox",`0 0 ${i} ${s}`).on("click",()=>this.select(null)),this.init()}init(){this.svg.append("g").classed("axises",!0).call(l=>l.append("g").classed("x-grid",!0)).call(l=>l.append("g").classed("y-grid",!0)).call(l=>l.append("g").classed("x-axis",!0)).call(l=>l.append("g").classed("y-axis",!0)).call(l=>l.append("g").classed("x-label",!0)).call(l=>l.append("g").classed("y-label",!0));const{left:t,top:e}=this.margin;this.brush=r.brush().extent([[t-.5,e-.5],[this.width+t+.5,this.height+e+.5]]).on("start",()=>this.brushing=!0).on("brush",({selection:l})=>this.brushed(l)).on("end",({selection:l})=>{this.brushed(l),this.brushing=!1}),this.svg.call(l=>l.append("g").classed("dots",!0)).call(l=>l.append("g").classed("brush",!0).call(this.brush)).call(l=>l.append("g").classed("select-dots",!0)).call(l=>l.append("g").classed("hover-dots",!0))}createScale(t,e){return t==="continuous"?e===b.QUANTILE?r.scaleQuantile():e===b.LOGARITHMIC?r.scaleLog():r.scaleLinear():r.scalePoint().padding(.5)}scaleDots(){this.dots.forEach((t,e)=>{t.attr("r",e===this.hoveredIndex||e===this.selectedIndex?w:D)})}colorizeDots(){if(this.dots.forEach((e,l)=>{const a=this.brushedIndexes!=null&&!this.brushedIndexes.includes(l);if(e.classed("disabled",a).attr("stroke","none"),a)e.attr("fill",null);else{var n;e.attr("fill",(n=this.colors[l])!==null&&n!==void 0?n:M)}}),this.hoverDots.forEach((e,l)=>e.classed("disabled",this.brushedIndexes!=null&&!this.brushedIndexes.includes(l))),this.selectedIndex!=null){var t;this.svg.selectAll(".select-dots circle").attr("stroke",(t=this.colors[this.selectedIndex])!==null&&t!==void 0?t:M)}}drawSelectedDot(){const t=this.svg.select(".select-dots");t.selectAll("*").remove(),this.dots.forEach((e,l)=>{if(l===this.selectedIndex){const a=e.attr("cx"),n=e.attr("cy"),g=e.attr("fill");t.append("circle").attr("cx",a).attr("cy",n).attr("r",R).attr("fill","none").attr("stroke",g).attr("stroke-width",1)}})}draw(){this.scale=this.scale.map((i,s)=>this.createScale(this.type[s],this.scaleMethod[s]));const{left:t,top:e}=this.margin,l=this.type.map((i,s)=>{const h=this.data.map(d=>d[s]);return i!=="continuous"?[...new Set(h)]:r.extent(h)}),a=[[t,this.width+t],[this.height+e,e]];this.scaleMethod.forEach((i,s)=>{if(i===b.QUANTILE){const h=this.ticks[s],d=(a[s][1]-a[s][0])/(h-1);a[s]=r.range(h).map(o=>a[s][0]+d*o)}}),this.scale.forEach((i,s)=>{i.domain(l[s]).range(a[s])}),[this.axis,this.grid,this.label].forEach(i=>{i.forEach((s,h)=>{s.scale(this.scale[h]),this.scaleMethod[h]===b.QUANTILE?s.tickValues(this.scale[h].quantiles()).tickFormat(r.format("-.2g")):(s.tickValues(null).tickFormat(null),this.type[h]==="continuous"&&s.ticks(this.ticks[h]))})}),this.grid[0].tickSize(this.height),this.grid[1].tickSize(this.width);const n=[this.svg.select(".x-axis"),this.svg.select(".y-axis")],g=[this.svg.select(".x-grid"),this.svg.select(".y-grid")],x=[this.svg.select(".x-label"),this.svg.select(".y-label")];[n,g,x].forEach(i=>{i[0].attr("transform",`translate(0, ${this.height+e})`).call(s=>s.selectAll("*").remove()),i[1].attr("transform",`translate(${t}, 0)`).call(s=>s.selectAll("*").remove())}),n.forEach((i,s)=>i.call(this.axis[s]).selectAll(".tick text").remove()),g.forEach((i,s)=>i.call(this.grid[s]).call(h=>h.selectAll(".tick text").remove()).call(h=>h.select(".domain").remove())),x.forEach((i,s)=>{this.labelVisible[s]&&i.call(this.label[s]).call(h=>h.selectAll(".tick line").remove()).call(h=>h.select(".domain").remove())});const f=this.svg.select(".dots"),p=this.svg.select(".hover-dots"),u=this.svg.select(".select-dots");f.selectAll("*").remove(),p.selectAll("*").remove(),u.selectAll("*").remove(),this.dots=[],this.hoverDots=[],this.data.forEach((i,s)=>{var h,d,o;const v=(h=this.scale[0](i[0]))!==null&&h!==void 0?h:0,I=(d=this.scale[1](i[1]))!==null&&d!==void 0?d:0,m=f.append("circle").attr("cx",v).attr("cy",I).attr("r",D).attr("fill",(o=this.colors[s])!==null&&o!==void 0?o:M),E=p.append("circle").attr("cx",v).attr("cy",I).attr("r",w).attr("fill","transparent").on("mouseenter",()=>{m.classed("disabled")||this.brushing||this.hover(s)}).on("mouseleave",()=>{m.classed("disabled")||this.brushing||this.hover(null)}).on("click",_=>{m.classed("disabled")||this.brushing||(this.select(s),_.stopPropagation())});this.dots.push(m),this.hoverDots.push(E)})}dataInSelection(t,[e,l]){const a=t===1?"y":"x",n=this.scaleMethod[t],g=this.scale[t],x=this.type[t],[f,p]=e<l?[e,l]:[l,e];if(x==="continuous"){let u,i;if(n===b.QUANTILE){const s=g,h=s.range(),d=h.filter(o=>f<=o&&o<=p).map(o=>{const v=s.invertExtent(o);return o===h[h.length-1]?[v[0],v[1]+1]:v});[u,i]=r.extent(r.merge(d))}else{const s=g.invert;u=s(f),i=s(p)}return a==="y"&&([u,i]=[i,u]),this.data.reduce((s,h,d)=>(h[t]>=u&&h[t]<=i&&s.push(d),s),[])}else{const u=g,i=u.domain(),s=u.step(),h=u.padding()*s,d=a==="x"?this.margin.left:this.margin.top;let o=(f-d-h)/s,v=(p-d-h)/s;a==="y"&&([o,v]=[v,o]);let I,m;return a==="x"?(I=Math.max(Math.floor(o)+1,0),m=Math.min(Math.ceil(v)-1,i.length-1)):(I=i.length-Math.min(Math.floor(o),i.length-1)-1,m=i.length-Math.max(Math.ceil(v),0)-1),this.data.reduce((E,_,S)=>{const T=i.indexOf(_[t]);return T>=I&&T<=m&&E.push(S),E},[])}}brushed(t){this.select(null);let e=null;t&&(e=O(...t.map((l,a)=>this.dataInSelection(a,[t[0][a],t[1][a]])))),this.clearableBrush(e),this.emit("brush",e)}clearableBrush(t,e=!1){e&&this.brush.clear(this.svg.select(".brush")),this.brushedIndexes=t,this.colorizeDots()}focus(t){this.clearableBrush(t,!0)}hover(t){t!==this.hoveredIndex&&(this.hoveredIndex=t,this.scaleDots(),this.emit("hover",t))}select(t){this.selectedIndex=t,this.scaleDots(),this.drawSelectedDot(),this.emit("select",t)}setColors(t){this.colors=t,this.colorizeDots(),this.drawSelectedDot()}setScaleMethod(t){this.scaleMethod=t,this.brushedIndexes=null,this.brush.clear(this.svg.select(".brush")),this.draw(),this.colorizeDots(),this.scaleDots()}render(t,e){this.hoveredIndex=null,this.selectedIndex=null,this.data=t,this.type=e,this.colors=[],this.draw()}dispose(){this.svg.remove()}}c(L,"MARGIN_WITHOUT_LABEL",8),c(L,"MARGIN_LEFT_WITH_LABEL",50),c(L,"MARGIN_BOTTOM_WITH_LABEL",30);
