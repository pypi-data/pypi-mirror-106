import Ke from"../../__snowpack__/env.js";import.meta.env=Ke;function fe(o,l){var i=Object.keys(o);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(o);l&&(c=c.filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable})),i.push.apply(i,c)}return i}function A(o){for(var l=1;l<arguments.length;l++){var i=arguments[l]!=null?arguments[l]:{};l%2?fe(Object(i),!0).forEach(function(c){Xe(o,c,i[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):fe(Object(i)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(i,c))})}return o}function Xe(o,l,i){return l in o?Object.defineProperty(o,l,{value:i,enumerable:!0,configurable:!0,writable:!0}):o[l]=i,o}import Ye,{AsideSection as I}from"../components/Aside.js";import ze from"../components/HighDimensionalPage/HighDimensionalChart.js";import Ge from"../components/HighDimensionalPage/LabelSearchInput.js";import t,{useCallback as _,useEffect as p,useMemo as r,useRef as Je,useState as a}from"../../web_modules/react.js";import Qe from"../components/BodyLoading.js";import Ze from"../components/Button.js";import et from"../components/Content.js";import tt from"../components/HighDimensionalPage/DimensionSwitch.js";import nt from"../components/Error.js";import m from"../components/Field.js";import ot from"../components/HighDimensionalPage/LabelSearchResult.js";import{LabelType as ve}from"../resource/high-dimensional/index.js";import at from"../components/HighDimensionalPage/PCADetail.js";import lt from"../components/HighDimensionalPage/ReductionTab.js";import it from"../components/ScatterChart/ScatterChart.js";import rt from"../components/Select.js";import st from"../components/HighDimensionalPage/TSNEDetail.js";import ct from"../components/Title.js";import dt from"../components/HighDimensionalPage/UMAPDetail.js";import mt from"../components/HighDimensionalPage/UploadDialog.js";import be from"../../web_modules/query-string.js";import{rem as z}from"../utils/style.js";import C from"../../web_modules/styled-components.js";import{toast as G}from"../../web_modules/react-toastify.js";import J from"../hooks/useRequest.js";import{useTranslation as ut}from"../../web_modules/react-i18next.js";import ht from"../hooks/useWorker.js";const pt=import.meta.env.MODE,gt={pca:5e4,tsne:1e4,umap:5e3},ft={pca:200,tsne:void 0,umap:void 0},vt=C.div.withConfig({displayName:"high-dimensional__AsideTitle",componentId:"kunowy-0"})(["font-size:",";line-height:",";font-weight:700;margin-bottom:",";"],z(16),z(16),z(20)),Q=C(rt).withConfig({displayName:"high-dimensional__FullWidthSelect",componentId:"kunowy-1"})(["width:100%;"]),bt=C(Ze).withConfig({displayName:"high-dimensional__FullWidthButton",componentId:"kunowy-2"})(["width:100%;"]),Ee=C(Ye).withConfig({displayName:"high-dimensional__HDAside",componentId:"kunowy-3"})([".secondary{color:var(--text-light-color);}"]),Et=C(Ee).withConfig({displayName:"high-dimensional__RightAside",componentId:"kunowy-4"})(["border-left:1px solid var(--border-color);"]),yt=C(Ee).withConfig({displayName:"high-dimensional__LeftAside",componentId:"kunowy-5"})(["border-right:1px solid var(--border-color);","{border-bottom:none;}> .aside-top > .search-result{margin-top:0;margin-left:0;margin-right:0;flex:auto;overflow:hidden auto;}"],I),_t=C(et).withConfig({displayName:"high-dimensional__HDContent",componentId:"kunowy-6"})(["background-color:var(--background-color);"]),Ct=()=>{const{t:o}=ut(["high-dimensional","common"]),l=Je(null),{data:i,loading:c}=J("/embedding/list"),g=r(()=>{var e;return(e=i==null?void 0:i.map(n=>A({value:n.name,label:n.name},n)))!==null&&e!==void 0?e:[]},[i]),[u,Z]=a(),E=r(()=>g.find(e=>e.value===u),[g,u]);p(()=>{var e,n;Z((e=(n=g[0])===null||n===void 0?void 0:n.value)!==null&&e!==void 0?e:void 0)},[g]);const{data:H,loading:ee}=J(u?`/embedding/tensor?${be.stringify({name:u})}`:null),{data:L,loading:te}=J(u?`/embedding/metadata?${be.stringify({name:u})}`:null),[ye,ne]=a(!1),[F,f]=a(!1),[k,y]=a("");p(()=>{F||y("")},[F]),p(()=>{k&&f(!0)},[k]),p(()=>{ee&&(f(!0),y("fetching-tensor"))},[ee]),p(()=>{te&&(f(!0),y("fetching-metadata"))},[te]);const[O,oe]=a(null),[ae,le]=a(null),_e=_(e=>{oe(e),le(null)},[]),[$,Ce]=a(""),[ie,De]=a(""),[we,je]=a(new Float32Array),[D,Pe]=a([]),x=r(()=>D.map(({label:e},n)=>({label:e,value:n})),[D]),[T,re]=a(0),se=r(()=>[{label:o("high-dimensional:no-color-map"),value:-1},...D.map((e,n)=>({label:e.label,value:n,disabled:e.type===ve.Null||e.type===ve.Category&&e.categories.length>it.CATEGORY_COLOR_MAP.length}))],[D,o]),[w,ce]=a(-1),[j,Se]=a([]),[B,Re]=a(0),[Oe,Ne]=a([0,0]),Ae=r(()=>j[T],[T,j]),Ie=r(()=>w===-1?null:A(A({},D[w]),{},{labels:j[w]}),[w,D,j]),[P,Le]=a("3d"),[v,xe]=a("pca"),V=r(()=>P==="3d",[P]),M=_((e,n,h)=>{if(n){f(!0),y(e);const s=new FileReader;s.readAsText(n,"utf-8"),s.onload=()=>{h(N=>{const R=s.result;return N===R&&f(!1),R})}}else h("")},[]);p(()=>M("reading-vector",O,Ce),[O,M]),p(()=>M("reading-metadata",ae,De),[ae,M]),p(()=>oe(null),[u]);const U=_(e=>{G(e.message,{position:G.POSITION.TOP_CENTER,type:G.TYPE.ERROR}),pt!=="production"&&console.error(e),f(!1)},[]),Te=r(()=>{const e={maxCount:gt[v],maxDimension:ft[v]};return $?{from:"string",params:A({vectors:$,metadata:ie},e)}:E&&H?{from:"blob",params:A({shape:E.shape,vectors:H.data,metadata:L!=null?L:""},e)}:null},[v,$,E,H,ie,L]),de=ht("high-dimensional/parse-data",Te);p(()=>{const{error:e,data:n}=de;e?U(e):n?(Ne(n.rawShape),Re(n.dimension),je(n.vectors),Pe(n.labels),re(0),ce(-1),Se(n.metadata)):n!==null?y("parsing"):(f(!1),y(""))},[de,U]);const me=r(()=>B!==0,[B]),W=r(()=>{var e;return O?O.name:(e=E==null?void 0:E.path)!==null&&e!==void 0?e:""},[O,E]),[q,Me]=a(5),[K,He]=a(10),[X,Fe]=a(15),ue=_(e=>{var n;Fe(e),(n=l.current)===null||n===void 0||n.rerunUMAP()},[]),[d,he]=a(),ke=_(()=>{he(void 0),y("calculating")},[]),$e=_(e=>{he(e),f(!1)},[]),[b,Be]=a({labelIndex:void 0,value:""}),S=r(()=>{if(b.labelIndex==null||b.value==="")return{indices:[],metadata:[]};const e=j[b.labelIndex],n=[],h=[];for(let s=0;s<e.length;s++)e[s].includes(b.value)&&(n.push(e[s]),h.push(s));return{indices:h,metadata:n}},[j,b.labelIndex,b.value]),[Ve,Ue]=a([]),pe=_(e=>Ue(e==null?[]:[S.indices[e]]),[S.indices]),ge=r(()=>{var e,n,h,s,N,R,Y;switch(v){case"pca":return t.createElement(at,{dimension:P,variance:(e=d==null?void 0:d.variance)!==null&&e!==void 0?e:[],totalVariance:(n=d==null?void 0:d.totalVariance)!==null&&n!==void 0?n:0});case"tsne":return t.createElement(st,{iteration:(h=d==null?void 0:d.step)!==null&&h!==void 0?h:0,perplexity:q,learningRate:K,is3D:V,onChangePerplexity:Me,onChangeLearningRate:He,onPause:(s=l.current)===null||s===void 0?void 0:s.pauseTSNE,onResume:(N=l.current)===null||N===void 0?void 0:N.resumeTSNE,onStop:(R=l.current)===null||R===void 0?void 0:R.pauseTSNE,onRerun:(Y=l.current)===null||Y===void 0?void 0:Y.rerunTSNE});case"umap":return t.createElement(dt,{neighbors:X,onRun:ue});default:return null}},[v,P,d,q,K,V,X,ue]),We=r(()=>t.createElement(Et,null,t.createElement(I,null,t.createElement(vt,null,o("high-dimensional:data")),t.createElement(m,{label:o("high-dimensional:select-data")},t.createElement(Q,{list:g,value:u,onChange:Z})),t.createElement(m,{label:o("high-dimensional:select-label")},t.createElement(Q,{list:x,value:T,onChange:re})),t.createElement(m,{label:o("high-dimensional:select-color")},t.createElement(Q,{list:se,value:w,onChange:ce})),t.createElement(m,null,t.createElement(bt,{rounded:!0,outline:!0,type:"primary",onClick:()=>ne(!0)},o("high-dimensional:upload-data"))),t.createElement(m,null,W&&t.createElement("div",{className:"secondary"},o("high-dimensional:data-path"),o("common:colon"),W))),t.createElement(I,null,t.createElement(m,null,t.createElement(lt,{value:v,onChange:xe})),t.createElement(m,{label:o("high-dimensional:dimension")},t.createElement(tt,{value:P,onChange:Le})),ge)),[o,g,u,x,T,se,w,W,v,P,ge]),qe=r(()=>t.createElement(yt,null,t.createElement(I,null,t.createElement(m,null,t.createElement(Ge,{labels:x,onChange:Be})),b.value!==""&&t.createElement(m,{className:"secondary"},t.createElement("span",null,o("high-dimensional:matched-result-count",{count:S.metadata.length})))),t.createElement(I,{className:"search-result"},t.createElement(m,null,t.createElement(ot,{list:S.metadata,onHovered:pe})))),[pe,x,b.value,S.metadata,o]);return t.createElement(t.Fragment,null,t.createElement(ct,null,o("common:high-dimensional")),F||c?t.createElement(Qe,null,o(`high-dimensional:loading.${k}`)):null,t.createElement(_t,{aside:We,leftAside:qe},me?t.createElement(ze,{ref:l,vectors:we,labels:Ae,colorMap:Ie,shape:Oe,dim:B,is3D:V,reduction:v,perplexity:q,learningRate:K,neighbors:X,focusedIndices:Ve,highlightIndices:S.indices,onCalculate:ke,onCalculated:$e,onError:U}):t.createElement(nt,null),t.createElement(mt,{open:ye,hasVector:me,onClose:()=>ne(!1),onChangeVectorFile:_e,onChangeMetadataFile:le})))};export default Ct;
